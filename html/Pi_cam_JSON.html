<!DOCTYPE html>
<html>

<head>
  <title>Pi Camera Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Fujifilm X-H2 Design System */
    :root {
      --fuji-black: #000000;
      --fuji-dark-gray: #1a1a1a;
      --fuji-medium-gray: #333333;
      --fuji-light-gray: #f5f5f5;
      --fuji-red: #e60012;
      --fuji-silver: #c0c0c0;
      --fuji-white: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
        sans-serif;
      text-align: center;
      background: linear-gradient(135deg,
          var(--fuji-black) 0%,
          var(--fuji-dark-gray) 100%);
      color: var(--fuji-white);
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--fuji-black);
      padding: 30px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      box-shadow: none;
    }

    h1 {
      color: var(--fuji-white);
      margin-bottom: 30px;
      font-weight: 300;
      letter-spacing: 3px;
      font-size: 24px;
      text-transform: uppercase;
    }

    .button {
      display: inline-block;
      padding: 15px 30px;
      margin: 10px;
      font-size: 18px;
      font-weight: 500;
      color: var(--fuji-black);
      text-decoration: none;
      border: none;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 150px;
      background: var(--fuji-white);
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: none;
    }

    .button:hover {
      background: var(--fuji-light-gray);
      transform: none;
    }

    .normal-btn {
      background: var(--fuji-red);
      color: var(--fuji-white);
    }

    .normal-btn:hover {
      background: #cc0010;
    }

    .highrez-btn {
      background: var(--fuji-white);
      color: var(--fuji-black);
    }

    .highrez-btn:hover {
      background: var(--fuji-light-gray);
    }

    .gallery-btn {
      background: var(--fuji-medium-gray);
      color: var(--fuji-white);
    }

    .gallery-btn:hover {
      background: var(--fuji-silver);
      color: var(--fuji-black);
    }

    .af-btn {
      background: var(--fuji-medium-gray);
      color: var(--fuji-white);
    }

    .af-btn:hover {
      background: var(--fuji-silver);
      color: var(--fuji-black);
    }

    .auto-btn {
      background: var(--fuji-red);
      color: var(--fuji-white);
      padding: 6px 12px;
      font-size: 11px;
      min-width: auto;
      margin: 0;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .auto-btn:disabled {
      background: var(--fuji-medium-gray);
      color: var(--fuji-silver);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 0;
      font-weight: bold;
      border: 1px solid var(--fuji-medium-gray);
    }

    .success {
      background: var(--fuji-dark-gray);
      color: #4caf50;
      border-color: #4caf50;
    }

    .info {
      background: var(--fuji-dark-gray);
      color: var(--fuji-white);
      border-color: var(--fuji-silver);
    }

    .error {
      background: var(--fuji-dark-gray);
      color: var(--fuji-red);
      border-color: var(--fuji-red);
    }

    .counters {
      margin: 20px 0;
      font-size: 14px;
      color: var(--fuji-silver);
      font-weight: 400;
      letter-spacing: 1px;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .photo-item {
      background: var(--fuji-dark-gray);
      padding: 10px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
    }

    .photo-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 0;
    }

    .photo-name {
      margin-top: 5px;
      font-size: 12px;
      color: var(--fuji-silver);
    }

    .af-info {
      background: var(--fuji-dark-gray);
      padding: 15px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      margin: 20px 0;
    }

    .camera-settings {
      background: var(--fuji-black);
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      margin: 20px 0;
      overflow: hidden;
    }

    .settings-header {
      background: var(--fuji-medium-gray);
      color: var(--fuji-white);
      padding: 15px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
      border-bottom: 1px solid var(--fuji-medium-gray);
    }

    .settings-header:hover {
      background: var(--fuji-silver);
      color: var(--fuji-black);
    }

    .settings-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 300;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .collapse-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }

    .collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .camera-status {
      background: var(--fuji-black);
      color: var(--fuji-white);
      padding: 15px;
      font-family: "SF Mono", "Monaco", "Cascadia Code", monospace;
      font-size: 12px;
      text-align: left;
      border-top: 1px solid var(--fuji-medium-gray);
      white-space: nowrap;
      overflow-x: auto;
      font-weight: 400;
      letter-spacing: 0.5px;
    }

    .camera-status .status-row {
      margin: 2px 0;
    }

    .settings-content {
      padding: 20px;
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }

    .collapsed .settings-content {
      max-height: 0;
      padding: 0 20px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px 0;
    }

    .setting-group {
      background: var(--fuji-dark-gray);
      padding: 15px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      box-shadow: none;
      transition: border-color 0.2s;
      overflow: hidden;
    }

    .setting-group:hover {
      transform: none;
      box-shadow: none;
      border-color: var(--fuji-silver);
    }

    .setting-group label {
      display: block;
      font-weight: 400;
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--fuji-white);
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .setting-group select,
    .setting-group input[type="range"],
    .setting-group input[type="number"] {
      width: calc(100%-4px);
      padding: 8px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      font-size: 12px;
      transition: border-color 0.2s;
      background: var(--fuji-black);
      color: var(--fuji-white);
      box-sizing: border-box;
    }

    .setting-group select:focus,
    .setting-group input:focus {
      border-color: var(--fuji-red);
      outline: none;
      box-shadow: none;
    }

    .value-display {
      display: inline-block;
      padding: 3px 8px;
      background: var(--fuji-red);
      color: var(--fuji-white);
      border: none;
      border-radius: 0;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .quick-presets {
      display: flex;
      gap: 6px;
      margin: 8px 0 0 0;
      flex-wrap: wrap;
    }

    .preset-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--fuji-medium-gray);
      color: var(--fuji-white);
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .preset-btn:hover {
      background: var(--fuji-red);
      border-color: var(--fuji-red);
    }

    .save-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 25px 0 15px 0;
    }

    .save-controls button {
      padding: 10px 20px;
      font-size: 12px;
    }

    .af-controls {
      margin: 15px 0;
    }

    .af-controls select,
    .af-controls input {
      padding: 8px;
      margin: 5px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      font-size: 14px;
      background: var(--fuji-black);
      color: var(--fuji-white);
    }

    .af-status {
      font-family: "SF Mono", "Monaco", "Cascadia Code", monospace;
      font-size: 14px;
      background: var(--fuji-black);
      color: var(--fuji-white);
      padding: 12px;
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      margin: 10px 0;
    }

    .hidden {
      display: none;
    }

    .shutter-display {
      font-size: 10px;
      color: var(--fuji-silver);
      margin-top: 3px;
    }

    .custom-shutter {
      margin-top: 8px;
      display: none;
    }

    /* Range slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      height: 2px;
      background: var(--fuji-medium-gray);
      border-radius: 0;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      margin: 8px 0;
      /* Add vertical margin for thumb space */
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 14px;
      /* Slightly smaller */
      width: 14px;
      background: var(--fuji-white);
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: var(--fuji-red);
    }

    input[type="range"]::-moz-range-thumb {
      height: 14px;
      width: 14px;
      background: var(--fuji-white);
      border: 1px solid var(--fuji-medium-gray);
      border-radius: 0;
      cursor: pointer;
      box-sizing: border-box;
    }

    input[type="range"]::-moz-range-thumb:hover {
      background: var(--fuji-red);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>📸 Pi Camera Control</h1>

    <div class="counters">
      <div>
        Normal Photos: <span id="photo-count">{{ photo_count }}</span>
      </div>
      <div>
        High-Res Photos: <span id="highrez-count">{{ highrez_count }}</span>
      </div>
    </div>

    <div class="af-info">
      <h3>🎯 Autofocus Status</h3>
      <div class="af-status" id="af-status">Loading AF status...</div>
      <div class="af-controls">
        <label>AF Mode:</label>
        <select id="af-mode" onchange="changeAFMode()">
          <option value="0">Manual</option>
          <option value="1">Auto (on capture)</option>
          <option value="2" selected>Continuous</option>
        </select>

        <label>AF Window:</label>
        <select id="af-window" onchange="changeAFWindow()">
          <option value="full">Full Frame</option>
          <option value="center" selected>Center 25%</option>
          <option value="center-large">Center 50%</option>
          <option value="top">Top 25%</option>
          <option value="bottom">Bottom 25%</option>
        </select>

        <div id="manual-controls" style="display: none">
          <label>Focus Position:</label>
          <input type="range" id="lens-position" min="0" max="10" step="0.1" value="3.0"
            onchange="changeLensPosition()" />
          <span id="lens-value">3.0</span>
          <small>(0.0=infinity, 10.0=close)</small>
        </div>

        <button class="button af-btn" onclick="triggerAF()" style="padding: 8px 15px; font-size: 14px">
          🎯 Trigger AF
        </button>
      </div>
    </div>

    <div class="camera-settings collapsed">
      <div class="settings-header" onclick="toggleSettings()">
        <h3>Camera Settings</h3>
        <span class="collapse-icon">🔼</span>
      </div>
      <div class="camera-status" id="camera-status">
        <div class="status-row" id="current-values">
          Loading camera settings...
        </div>
      </div>
      <div class="settings-content">
        <div class="settings-grid">
          <div class="setting-group">
            <label>
              Exposure Mode:
              <button class="auto-btn" id="auto-exposure-btn" onclick="enableAutoExposure()" disabled>
                AUTO
              </button>
            </label>
            <div style="font-size: 11px; color: #666; margin-top: 5px">
              Adjust manual settings to enable AUTO mode
            </div>
          </div>

          <div class="setting-group">
            <label>
              Shutter Speed:
              <span class="value-display" id="shutter-display">1/125s</span>
            </label>
            <select id="shutter-speed">
              <option value="1000">1/1000s</option>
              <option value="500">1/500s</option>
              <option value="250">1/250s</option>
              <option value="125" selected>1/125s</option>
              <option value="60">1/60s</option>
              <option value="30">1/30s</option>
              <option value="15">1/15s</option>
              <option value="8">1/8s</option>
              <option value="4">1/4s</option>
              <option value="custom">Custom μs...</option>
            </select>
            <input type="number" id="custom-shutter" class="custom-shutter" min="100" max="200000" step="100"
              placeholder="Microseconds" />
          </div>

          <div class="setting-group">
            <label>
              ISO Sensitivity:
              <span class="value-display" id="iso-value">ISO 100</span>
            </label>
            <input type="range" id="iso-gain" min="1" max="16" step="0.1" value="1.0" />
            <div class="quick-presets">
              <button class="preset-btn" onclick="setISO(1.0)">100</button>
              <button class="preset-btn" onclick="setISO(2.0)">200</button>
              <button class="preset-btn" onclick="setISO(4.0)">400</button>
              <button class="preset-btn" onclick="setISO(8.0)">800</button>
              <button class="preset-btn" onclick="setISO(16.0)">1600</button>
            </div>
          </div>

          <div class="setting-group">
            <label>White Balance:</label>
            <select id="awb-mode">
              <option value="0">Auto</option>
              <option value="1">Incandescent</option>
              <option value="2">Tungsten</option>
              <option value="3">Fluorescent</option>
              <option value="4">Indoor</option>
              <option value="5">Daylight</option>
              <option value="6">Cloudy</option>
            </select>
          </div>

          <div class="setting-group">
            <label>
              Brightness:
              <span class="value-display" id="brightness-value">0.0</span>
            </label>
            <input type="range" id="brightness" min="-1" max="1" step="0.1" value="0" />
            <div class="quick-presets">
              <button class="preset-btn" onclick="setBrightness(-0.5)">
                Dark
              </button>
              <button class="preset-btn" onclick="setBrightness(0)">
                Normal
              </button>
              <button class="preset-btn" onclick="setBrightness(0.5)">
                Bright
              </button>
            </div>
          </div>

          <div class="setting-group">
            <label>
              Contrast:
              <span class="value-display" id="contrast-value">1.0</span>
            </label>
            <input type="range" id="contrast" min="0" max="2" step="0.1" value="1" />
            <div class="quick-presets">
              <button class="preset-btn" onclick="setContrast(0.7)">
                Soft
              </button>
              <button class="preset-btn" onclick="setContrast(1.0)">
                Normal
              </button>
              <button class="preset-btn" onclick="setContrast(1.5)">
                Punchy
              </button>
            </div>
          </div>

          <div class="setting-group">
            <label>
              Saturation:
              <span class="value-display" id="saturation-value">1.0</span>
            </label>
            <input type="range" id="saturation" min="0" max="2" step="0.1" value="1" />
            <div class="quick-presets">
              <button class="preset-btn" onclick="setSaturation(0.5)">
                Muted
              </button>
              <button class="preset-btn" onclick="setSaturation(1.0)">
                Natural
              </button>
              <button class="preset-btn" onclick="setSaturation(1.5)">
                Vivid
              </button>
            </div>
          </div>

          <div class="setting-group">
            <label>
              Sharpness:
              <span class="value-display" id="sharpness-value">1.0</span>
            </label>
            <input type="range" id="sharpness" min="0" max="2" step="0.1" value="1" />
            <div class="quick-presets">
              <button class="preset-btn" onclick="setSharpness(0.5)">
                Soft
              </button>
              <button class="preset-btn" onclick="setSharpness(1.0)">
                Normal
              </button>
              <button class="preset-btn" onclick="setSharpness(1.8)">
                Sharp
              </button>
            </div>
          </div>
        </div>

        <div class="save-controls">
          <button class="button normal-btn" id="save-settings-btn" onclick="saveAllSettings()">
            Save Settings
          </button>
          <button class="button af-btn" onclick="resetCameraSettings()">
            Reset All
          </button>
        </div>
      </div>
    </div>

    <div>
      <button class="button normal-btn" onclick="takePhoto('normal')">
        Normal Photo<br />
        <small>(2304×1296)</small>
      </button>

      <button class="button highrez-btn" onclick="takePhoto('highrez')">
        High-Res Photo<br />
        <small>(4608×2592)</small>
      </button>
    </div>

    <div>
      <button class="button gallery-btn" onclick="toggleGallery()">
        View Photos
      </button>

      <button class="button" onclick="clearAllPhotos()" style="background: var(--fuji-red); color: var(--fuji-white);">
        Clear All Images
      </button>
    </div>
    <div id="status" class="status hidden"></div>

    <div id="gallery" class="hidden">
      <h3>Photo Gallery</h3>
      <div id="photo-grid" class="photo-grid"></div>
    </div>
  </div>

  <script>
    let settingsChanged = false;
    let autoExposureEnabled = true;

    function takePhoto(type) {
      const statusDiv = document.getElementById("status");
      statusDiv.className = "status info";
      statusDiv.textContent =
        type === "normal"
          ? "Taking normal photo..."
          : "Taking high-res photo...";
      statusDiv.classList.remove("hidden");

      fetch("/capture/" + type, { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            statusDiv.className = "status success";
            statusDiv.textContent = `✅ ${data.filename} captured in ${data.time}s`;

            // Update counters
            if (type === "normal") {
              document.getElementById("photo-count").textContent =
                data.photo_count;
            } else {
              document.getElementById("highrez-count").textContent =
                data.highrez_count;
            }

            // Refresh gallery if visible
            if (
              !document.getElementById("gallery").classList.contains("hidden")
            ) {
              loadGallery();
            }
          } else {
            statusDiv.className = "status error";
            statusDiv.textContent = "❌ Error: " + data.error;
          }
        })
        .catch((error) => {
          statusDiv.className = "status error";
          statusDiv.textContent = "❌ Network error: " + error;
        });
    }

    function toggleGallery() {
      const gallery = document.getElementById("gallery");
      if (gallery.classList.contains("hidden")) {
        gallery.classList.remove("hidden");
        loadGallery();
      } else {
        gallery.classList.add("hidden");
      }
    }

    function loadGallery() {
      fetch("/gallery")
        .then((response) => response.json())
        .then((data) => {
          const grid = document.getElementById("photo-grid");
          grid.innerHTML = "";

          data.photos.forEach((photo) => {
            const item = document.createElement("div");
            item.className = "photo-item";

            // Handle both old format (string) and new format (object)
            let photoPath, photoName, photoType;
            if (typeof photo === "string") {
              // Old format - just filename
              photoPath = photo;
              photoName = photo;
              photoType = "";
            } else {
              // New format - object with path, filename, type
              photoPath = photo.path;
              photoName = photo.filename;
              photoType = photo.type;
            }

            const typeLabel = photoType ? ` (${photoType})` : "";

            item.innerHTML = `
          <img src="/photo/${photoPath}" alt="${photoName}" onclick="window.open('/photo/${photoPath}', '_blank')">
          <div class="photo-name">${photoName}${typeLabel}</div>
        `;
            grid.appendChild(item);
          });
        });
    }
    function clearAllPhotos() {
      // Double confirmation for safety
      const normalCount = document.getElementById('photo-count').textContent;
      const highrezCount = document.getElementById('highrez-count').textContent;
      const totalPhotos = parseInt(normalCount) + parseInt(highrezCount);

      if (totalPhotos === 0) {
        showStatus('info', 'No photos to delete');
        return;
      }

      const confirmed = confirm(
        `⚠️ WARNING: This will permanently delete ALL ${totalPhotos} photos!\n\n` +
        `Normal photos: ${normalCount}\n` +
        `High-res photos: ${highrezCount}\n\n` +
        `This action cannot be undone. Are you sure?`
      );

      if (!confirmed) return;

      // Second confirmation
      const doubleConfirmed = confirm(
        `🚨 FINAL WARNING!\n\n` +
        `You are about to delete ${totalPhotos} photos permanently.\n\n` +
        `Type "DELETE" in the next prompt to confirm.`
      );

      if (!doubleConfirmed) return;

      const typeConfirm = prompt('Type "DELETE" to confirm deletion:');
      if (typeConfirm !== 'DELETE') {
        showStatus('info', 'Deletion cancelled - text did not match');
        return;
      }

      // Proceed with deletion
      showStatus('info', 'Deleting all photos...');

      fetch('/clear_all_photos', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showStatus('success', `✅ Successfully deleted ${data.deleted_count} photos`);

            // Update counters
            document.getElementById('photo-count').textContent = '0';
            document.getElementById('highrez-count').textContent = '0';

            // Clear gallery if visible
            const gallery = document.getElementById('gallery');
            if (!gallery.classList.contains('hidden')) {
              document.getElementById('photo-grid').innerHTML = '';
            }

            // Auto-hide gallery after clearing
            setTimeout(() => {
              gallery.classList.add('hidden');
            }, 2000);

          } else {
            showStatus('error', '❌ Error deleting photos: ' + data.error);
          }
        })
        .catch(error => {
          showStatus('error', '❌ Network error: ' + error);
        });
    }

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');

      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 5000);
      }
    }
    function updatePhotoCounts() {
      fetch("/photo_counts")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("photo-count").textContent =
            data.normal_count;
          document.getElementById("highrez-count").textContent =
            data.highrez_count;
        })
        .catch((error) => {
          console.error("Failed to update photo counts:", error);
        });
    }

    function updateAFStatus() {
      fetch("/af_status")
        .then((response) => response.json())
        .then((data) => {
          const statusDiv = document.getElementById("af-status");
          const afStates = {
            0: "Inactive",
            1: "Passive Scan",
            2: "Passive Focused",
            3: "Active Scan",
            4: "Focused",
            5: "Failed",
          };

          const afModes = { 0: "Manual", 1: "Auto", 2: "Continuous" };

          statusDiv.innerHTML = `
                        <strong>Mode:</strong> ${afModes[data.af_mode] || "Unknown"
            } (${data.af_mode})<br>
                        <strong>State:</strong> ${afStates[data.af_state] || "Unknown"
            } (${data.af_state})<br>
                        <strong>Lens Position:</strong> ${data.lens_position.toFixed(
              2
            )}<br>
                        <strong>Last Update:</strong> ${new Date().toLocaleTimeString()}
                    `;
        });
    }

    function updateCameraSettings() {
      console.log("Fetching camera settings...");
      fetch("/camera_settings")
        .then((response) => {
          console.log("Response status:", response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          console.log("Camera settings received:", data);
          if (data.error) {
            console.error("Camera settings error:", data.error);
            document.getElementById(
              "current-values"
            ).innerHTML = `Error: ${data.error}`;
            return;
          }

          const valuesDiv = document.getElementById("current-values");
          const shutterFraction = Math.round(1000000 / data.exposure_time);
          const isoEquiv = Math.round(data.analogue_gain * 100);

          // Canon-style status display without emojis
          valuesDiv.innerHTML = `
                        1/${shutterFraction}s  f/2.8  ISO${isoEquiv}  WB:${data.colour_gains[0].toFixed(
            1
          )}/${data.colour_gains[1].toFixed(
            1
          )}  DG:${data.digital_gain.toFixed(
            2
          )}  AF:${data.lens_position.toFixed(1)}  ${Math.round(
            data.frame_duration / 1000
          )}ms
                    `;

          updateUIValues(data);
        })
        .catch((error) => {
          console.error("Failed to fetch camera settings:", error);
          document.getElementById(
            "current-values"
          ).innerHTML = `Error: ${error.message}`;
        });
    }

    function updateUIValues(data) {
      // Update display values without triggering change events
      const isoEquiv = Math.round(data.analogue_gain * 100);
      document.getElementById("iso-value").textContent = `ISO ${isoEquiv}`;
      document.getElementById("brightness-value").textContent = (
        data.brightness || 0
      ).toFixed(1);
      document.getElementById("contrast-value").textContent = (
        data.contrast || 1
      ).toFixed(1);
      document.getElementById("saturation-value").textContent = (
        data.saturation || 1
      ).toFixed(1);
      document.getElementById("sharpness-value").textContent = (
        data.sharpness || 1
      ).toFixed(1);

      // Update shutter display
      const shutterFraction = Math.round(1000000 / data.exposure_time);
      document.getElementById(
        "shutter-display"
      ).textContent = `1/${shutterFraction}s`;
    }

    function updateAutoExposureButton(aeEnabled) {
      autoExposureEnabled = aeEnabled;
      const autoBtn = document.getElementById("auto-exposure-btn");

      if (aeEnabled) {
        autoBtn.disabled = true;
        autoBtn.style.backgroundColor = "var(--fuji-medium-gray)";
      } else {
        autoBtn.disabled = false;
        autoBtn.style.backgroundColor = "var(--fuji-red)";
      }
      autoBtn.textContent = "AUTO"; // This never changes
    }

    function enableAutoExposure() {
      fetch("/set_camera_setting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ control: "AeEnable", value: true }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            autoExposureEnabled = true;
            updateAutoExposureButton(true); // This will disable the button
            setTimeout(updateCameraSettings, 200);
          }
        });
    }

    function markSettingsChanged() {
      settingsChanged = true;
      const saveBtn = document.getElementById("save-settings-btn");
      saveBtn.disabled = false;
      saveBtn.style.opacity = "1";
      saveBtn.style.background = "var(--fuji-red)";
      saveBtn.textContent = "Save Settings *";

      const header = document.querySelector(".settings-header");
      header.style.background = "var(--fuji-red)";

      if (autoExposureEnabled) {
        fetch("/set_camera_setting", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ control: "AeEnable", value: false }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              autoExposureEnabled = false; // Update our state but don't change button
            }
          });
      }
    }

    function saveAllSettings() {
      const settings = {
        AeEnable: autoExposureEnabled,
        ExposureTime: getShutterValue(),
        AnalogueGain: parseFloat(document.getElementById("iso-gain").value),
        AwbMode: parseInt(document.getElementById("awb-mode").value),
        Brightness: parseFloat(document.getElementById("brightness").value),
        Contrast: parseFloat(document.getElementById("contrast").value),
        Saturation: parseFloat(document.getElementById("saturation").value),
        Sharpness: parseFloat(document.getElementById("sharpness").value),
      };

      const saveBtn = document.getElementById("save-settings-btn");
      saveBtn.textContent = "Saving...";
      saveBtn.disabled = true;

      fetch("/save_all_settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(settings),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Always enable AUTO button after saving settings
            const autoBtn = document.getElementById("auto-exposure-btn");
            autoBtn.disabled = false;
            autoBtn.style.backgroundColor = "var(--fuji-red)";

            settingsChanged = false;
            saveBtn.disabled = false;
            saveBtn.style.background = "#4CAF50";
            saveBtn.textContent = "✓ Settings Saved";

            const header = document.querySelector(".settings-header");
            header.style.background = "var(--fuji-medium-gray)";

            setTimeout(() => {
              saveBtn.textContent = "Save Settings";
              saveBtn.style.background = "var(--fuji-medium-gray)";
              saveBtn.disabled = false;
              saveBtn.style.opacity = "1";
            }, 2000);

            setTimeout(updateCameraSettings, 500);
          } else {
            saveBtn.textContent = "Save Failed";
            saveBtn.style.background = "#f44336";
            setTimeout(() => {
              saveBtn.textContent = "Save Settings *";
              saveBtn.style.background = "var(--fuji-red)";
              saveBtn.disabled = false;
            }, 2000);
          }
        });
    }

    function getShutterValue() {
      const shutterSelect = document.getElementById("shutter-speed");
      if (shutterSelect.value === "custom") {
        return (
          parseInt(document.getElementById("custom-shutter").value) || 8000
        );
      }
      return Math.round(1000000 / parseInt(shutterSelect.value));
    }

    function changeShutterSpeed(value) {
      if (value === "custom") {
        document.getElementById("custom-shutter").style.display = "block";
      } else {
        document.getElementById("custom-shutter").style.display = "none";
      }
      markSettingsChanged();
    }

    function toggleSettings() {
      const settings = document.querySelector(".camera-settings");
      settings.classList.toggle("collapsed");
    }

    function setISO(value) {
      document.getElementById("iso-gain").value = value;
      document.getElementById("iso-value").textContent = `ISO ${Math.round(
        value * 100
      )}`;
      markSettingsChanged();
    }

    function setBrightness(value) {
      document.getElementById("brightness").value = value;
      document.getElementById("brightness-value").textContent =
        value.toFixed(1);
      markSettingsChanged();
    }

    function setContrast(value) {
      document.getElementById("contrast").value = value;
      document.getElementById("contrast-value").textContent =
        value.toFixed(1);
      markSettingsChanged();
    }

    function setSaturation(value) {
      document.getElementById("saturation").value = value;
      document.getElementById("saturation-value").textContent =
        value.toFixed(1);
      markSettingsChanged();
    }

    function setSharpness(value) {
      document.getElementById("sharpness").value = value;
      document.getElementById("sharpness-value").textContent =
        value.toFixed(1);
      markSettingsChanged();
    }

    function resetCameraSettings() {
      fetch("/reset_camera_settings", { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Reset UI controls
            document.getElementById("shutter-speed").value = "125";
            document.getElementById("iso-gain").value = "1.0";
            document.getElementById("awb-mode").value = "0";
            document.getElementById("brightness").value = "0";
            document.getElementById("contrast").value = "1";
            document.getElementById("saturation").value = "1";
            document.getElementById("sharpness").value = "1";

            setTimeout(updateCameraSettings, 500);
          }
        });
    }

    function changeAFMode() {
      const mode = document.getElementById("af-mode").value;
      const manualControls = document.getElementById("manual-controls");

      // Show/hide manual controls
      if (mode === "0") {
        manualControls.style.display = "block";
      } else {
        manualControls.style.display = "none";
      }

      fetch("/set_af_mode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode: parseInt(mode) }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            updateAFStatus();
          }
        });
    }

    function changeAFWindow() {
      const window = document.getElementById("af-window").value;

      fetch("/set_af_window", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ window: window }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            updateAFStatus();
          }
        });
    }

    function changeLensPosition() {
      const position = document.getElementById("lens-position").value;
      document.getElementById("lens-value").textContent = position;

      fetch("/set_lens_position", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ position: parseFloat(position) }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            updateAFStatus();
          }
        });
    }

    function triggerAF() {
      fetch("/trigger_af", { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            setTimeout(updateAFStatus, 500); // Wait for AF to complete
          }
        });
    }

    // Add event listeners
    document.addEventListener("DOMContentLoaded", function () {
      console.log("JavaScript loaded");

      const saveBtn = document.getElementById("save-settings-btn");
      saveBtn.disabled = false;
      saveBtn.style.opacity = "1";
      saveBtn.style.background = "var(--fuji-medium-gray)";
      saveBtn.textContent = "Save Settings";

      setTimeout(updatePhotoCounts, 2000);

      document
        .getElementById("iso-gain")
        .addEventListener("input", function () {
          const value = parseFloat(this.value);
          document.getElementById(
            "iso-value"
          ).textContent = `ISO ${Math.round(value * 100)}`;
          markSettingsChanged();
        });

      document
        .getElementById("brightness")
        .addEventListener("input", function () {
          const value = parseFloat(this.value);
          document.getElementById("brightness-value").textContent =
            value.toFixed(1);
          markSettingsChanged();
        });

      document
        .getElementById("contrast")
        .addEventListener("input", function () {
          const value = parseFloat(this.value);
          document.getElementById("contrast-value").textContent =
            value.toFixed(1);
          markSettingsChanged();
        });

      document
        .getElementById("saturation")
        .addEventListener("input", function () {
          const value = parseFloat(this.value);
          document.getElementById("saturation-value").textContent =
            value.toFixed(1);
          markSettingsChanged();
        });

      document
        .getElementById("sharpness")
        .addEventListener("input", function () {
          const value = parseFloat(this.value);
          document.getElementById("sharpness-value").textContent =
            value.toFixed(1);
          markSettingsChanged();
        });

      document
        .getElementById("shutter-speed")
        .addEventListener("change", function () {
          changeShutterSpeed(this.value);
        });

      document
        .getElementById("awb-mode")
        .addEventListener("change", markSettingsChanged);
      document
        .getElementById("custom-shutter")
        .addEventListener("input", markSettingsChanged);

      // Initial status loads
      setTimeout(updateAFStatus, 1000);
      setTimeout(updateCameraSettings, 1500);
    });

    // Update AF status every 2 seconds
    setInterval(updateAFStatus, 2000);
    // Update camera settings every 3 seconds
    setInterval(updateCameraSettings, 3000);
    // Update photo counts every 10 seconds
    setInterval(updatePhotoCounts, 5000);
    // Auto-hide status after 5 seconds
    setInterval(() => {
      const statusDiv = document.getElementById("status");
      if (
        !statusDiv.classList.contains("hidden") &&
        statusDiv.classList.contains("success")
      ) {
        setTimeout(() => statusDiv.classList.add("hidden"), 3000);
      }
    }, 100);
  </script>
</body>

</html>